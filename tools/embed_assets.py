#!/usr/bin/env python3
"""
ESP32 Web Assets Embedding Tool
CSS/JS/Faviconã‚’gzipåœ§ç¸®ã—ã¦ESP32ç”¨ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›
"""

import gzip
import os
import sys


def compress_file(file_path):
    """ãƒ•ã‚¡ã‚¤ãƒ«ã‚’gzipåœ§ç¸®"""
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    return gzip.compress(content.encode('utf-8'), compresslevel=9)


def write_array(f, name, data, description):
    """Cé…åˆ—ã‚’å‡ºåŠ›"""
    f.write(f'\n// {description}\n')
    f.write(f'const uint32_t {name}_len = {len(data)};\n')
    f.write(f'const uint8_t {name}[] PROGMEM = {{\n  ')

    for i, byte in enumerate(data):
        f.write(f'0x{byte:02x}')
        if i < len(data) - 1:
            f.write(',')
            if (i + 1) % 16 == 0:
                f.write('\n  ')
            else:
                f.write(' ')

    f.write('\n};\n')


def main():
    # ãƒ‘ã‚¹è¨­å®š
    base_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
    html_path = os.path.join(base_dir, 'gui/dist/index.html')
    css_path = os.path.join(base_dir, 'gui/dist/app.css')
    js_path = os.path.join(base_dir, 'gui/dist/app.js')
    favicon_path = os.path.join(base_dir, 'gui/public/favicon.svg')
    output_path = os.path.join(base_dir, 'esp32_app/WebAssets.h')

    # ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯
    files_to_check = [
        (html_path, 'HTML'),
        (css_path, 'CSS'),
        (js_path, 'JavaScript'),
        (favicon_path, 'Favicon')
    ]

    missing_files = []
    for path, name in files_to_check:
        if not os.path.exists(path):
            missing_files.append(f"{name}: {path}")

    if missing_files:
        print("âŒ Error: Missing files:")
        for msg in missing_files:
            print(f"   - {msg}")
        sys.exit(1)

    print("ğŸ“¦ Compressing assets...")

    # ãƒ•ã‚¡ã‚¤ãƒ«åœ§ç¸®
    html_gz = compress_file(html_path)
    css_gz = compress_file(css_path)
    js_gz = compress_file(js_path)
    favicon_gz = compress_file(favicon_path)

    # ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
    print("ğŸ“ Generating WebAssets.h...")

    with open(output_path, 'w') as f:
        # ãƒ˜ãƒƒãƒ€ãƒ¼
        f.write('// Auto-generated file - DO NOT EDIT MANUALLY\n')
        f.write('// Generated by tools/embed_assets.py\n')
        f.write('#ifndef WEB_ASSETS_H\n')
        f.write('#define WEB_ASSETS_H\n\n')
        f.write('#include <Arduino.h>\n')

        # HTML
        write_array(f, 'index_html_gz', html_gz, 'HTML (gzip compressed)')

        # CSS
        write_array(f, 'app_css_gz', css_gz, 'CSS (gzip compressed)')

        # JavaScript
        write_array(f, 'app_js_gz', js_gz, 'JavaScript (gzip compressed)')

        # Favicon
        write_array(f, 'favicon_svg_gz', favicon_gz,
                    'Favicon SVG (gzip compressed)')

        # ãƒ•ãƒƒã‚¿ãƒ¼
        f.write('\n#endif // WEB_ASSETS_H\n')

    # ã‚µãƒãƒªãƒ¼è¡¨ç¤º
    total_size = len(html_gz) + len(css_gz) + len(js_gz) + len(favicon_gz)

    print("\nâœ… WebAssets.h generated successfully!")
    print(f"\nğŸ“Š Asset sizes (gzip compressed):")
    print(f"   HTML:    {len(html_gz):>7,} bytes")
    print(f"   CSS:     {len(css_gz):>7,} bytes")
    print(f"   JS:      {len(js_gz):>7,} bytes")
    print(f"   Favicon: {len(favicon_gz):>7,} bytes")
    print(f"   {'â”€' * 24}")
    print(f"   Total:   {total_size:>7,} bytes ({total_size / 1024:.1f} KB)")


if __name__ == '__main__':
    main()
